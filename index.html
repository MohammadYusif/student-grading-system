<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Grading System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 40px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.95rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .students-grid {
            padding: 40px;
            display: none;
        }

        .student-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .student-info h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .student-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .total-grade {
            text-align: right;
        }

        .total-grade-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .total-grade-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .grade-input-group {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
        }

        .grade-input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .grade-input-group input[type="number"] {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .grade-input-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }

        .grade-input-group input[type="checkbox"],
        .grade-input-group input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .grade-input-group label {
            cursor: pointer;
            user-select: none;
        }

        .grade-input-group label:hover {
            color: #667eea;
        }

        details {
            border-left: 3px solid #e0e0e0;
            padding-left: 10px;
            margin-bottom: 10px;
        }

        details[open] {
            border-left-color: #667eea;
        }

        details summary {
            outline: none;
        }

        details summary:hover {
            color: #667eea;
        }

        .zip-section {
            background: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .zip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .zip-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zip-url {
            font-size: 0.85rem;
            color: #666;
            word-break: break-all;
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .files-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .files-list.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-item:hover {
            background: #f8f9ff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-size: 0.9rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .file-icon {
            color: #667eea;
        }

        .colab-btn {
            background: #f9ab00;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .colab-btn:hover {
            background: #e69900;
            transform: translateY(-1px);
        }

        .student-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9rem;
        }

        .file-name-display {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 6px;
            font-weight: 600;
        }

        .summary-section {
            background: #f8f9ff;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .grades-grid {
                grid-template-columns: 1fr;
            }

            .summary-stats {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .student-actions {
                justify-content: center;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .file-name {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Student Grading System</h1>
            <p>Upload Excel, process zip files, and grade with Google Colab integration</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Upload Excel file with student data & Zip File URLs</div>
                <div class="upload-subtext">Required columns: Full Name, ID/IQAMA Number, Email, Zip File URL</div>
                <div class="upload-subtext" style="margin-top: 5px; font-size: 0.85rem; color: #888;">üí° Tip: Zip File URLs should point to Google Drive folders with all solved notebooks</div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
            </div>
            <div id="fileNameDisplay"></div>
        </div>

        <div class="students-grid" id="studentsGrid">
            <div class="summary-section">
                <div class="summary-stats">
                    <div class="stat">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="gradedStudents">0</div>
                        <div class="stat-label">Graded</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="pendingStudents">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-success" onclick="downloadAllSheets()">
                        üì• Download All Sheets
                    </button>
                    <button class="btn btn-secondary" onclick="resetApp()">
                        üîÑ New File
                    </button>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #666; text-align: right;">
                        üí° Downloaded file includes Zip File URLs for future re-grading
                    </div>
                </div>
            </div>
            <div id="studentCards"></div>
        </div>
    </div>

    <script>
        let studentsData = [];
        let originalFileName = '';

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please upload an Excel file (.xlsx or .xls)');
                return;
            }

            originalFileName = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                processStudentData(jsonData);
                displayStudents();
                
                document.getElementById('fileNameDisplay').innerHTML = 
                    `<div class="file-name-display">‚úÖ ${file.name} loaded successfully</div>`;
            };

            reader.readAsArrayBuffer(file);
        }

        function processStudentData(data) {
            studentsData = data.map((row, index) => ({
                id: index + 1,
                fullName: row['Full Name'] || '',
                idNumber: row['ID/IQAMA Number'] || '',
                email: row['Email'] || '',
                zipUrl: row['Zip File URL'] || row['Please upload a zip file of all solved notebooks!'] || '',
                q1Grade: row['Q1 Grade'] || '',
                q1AIFlag: row['Q1 AI Flag'] === 'yes',
                q2Grade: row['Q2 Grade'] || '',
                q2AIFlag: row['Q2 AI Flag'] === 'yes',
                q3Grade: row['Q3 Grade'] || '',
                q3AIFlag: row['Q3 AI Flag'] === 'yes',
                totalGrade: row['Total Grade'] || '',
                zipFiles: [],
                zipLoaded: false,
                zipExpanded: false,
                isGoogleDrive: false
            }));
        }

        function isGoogleDriveLink(url) {
            return url.includes('drive.google.com') || url.includes('docs.google.com');
        }

        function convertGoogleDriveLink(url) {
            // Try to extract file ID from various Google Drive URL formats
            let fileId = null;
            
            // Format: https://drive.google.com/file/d/FILE_ID/view
            const match1 = url.match(/\/file\/d\/([^\/]+)/);
            if (match1) fileId = match1[1];
            
            // Format: https://drive.google.com/open?id=FILE_ID
            const match2 = url.match(/[?&]id=([^&]+)/);
            if (match2) fileId = match2[1];
            
            if (fileId) {
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
            return url;
        }

        async function loadZipFile(index) {
            const student = studentsData[index];
            if (!student.zipUrl || student.zipLoaded) return;

            const btn = document.getElementById(`load-zip-${index}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;

            // Check if it's a Google Drive link
            let fetchUrl = student.zipUrl;
            if (isGoogleDriveLink(student.zipUrl)) {
                fetchUrl = convertGoogleDriveLink(student.zipUrl);
                console.log('Converted Google Drive URL:', fetchUrl);
            }

            try {
                // Fetch the zip file with CORS mode
                const response = await fetch(fetchUrl, {
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    // If Google Drive link fails, show special instructions
                    if (isGoogleDriveLink(student.zipUrl)) {
                        throw new Error('GOOGLE_DRIVE');
                    }
                    throw new Error('Failed to fetch zip file');
                }

                const blob = await response.blob();
                const zip = await JSZip.loadAsync(blob);

                // Extract .ipynb files
                const files = [];
                zip.forEach((relativePath, file) => {
                    if (relativePath.endsWith('.ipynb') && !file.dir) {
                        files.push({
                            name: relativePath.split('/').pop(), // Get filename only
                            fullPath: relativePath,
                            file: file
                        });
                    }
                });

                student.zipFiles = files;
                student.zipLoaded = true;
                student.zipExpanded = true;
                student.isGoogleDrive = isGoogleDriveLink(student.zipUrl);

                // Update the UI
                displayZipFiles(index);
                btn.innerHTML = '‚úÖ Loaded (' + files.length + ' files)';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');

            } catch (error) {
                console.error('Error loading zip:', error);
                
                // Special handling for Google Drive
                if (error.message === 'GOOGLE_DRIVE' || isGoogleDriveLink(student.zipUrl)) {
                    btn.innerHTML = 'üìÅ Google Drive Link';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-info');
                    btn.disabled = false;
                    
                    // Show Google Drive instructions
                    displayGoogleDriveInstructions(index);
                } else {
                    btn.innerHTML = '‚ùå Failed to Load';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-danger');
                    btn.disabled = false;
                    
                    alert('Failed to load zip file. Possible reasons:\n\n1. URL requires authentication\n2. CORS policy blocking\n3. File not accessible\n\nTry using a publicly accessible link (e.g., Dropbox, direct link).');
                }
            }
        }

        function displayGoogleDriveInstructions(index) {
            const student = studentsData[index];
            const container = document.getElementById(`zip-files-${index}`);
            
            container.innerHTML = `
                <div style="background: #fff; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üìÅ</span>
                        <span>Google Drive Link Detected</span>
                    </h4>
                    <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                        This student submitted a Google Drive link. Follow these steps to access their notebooks:
                    </p>
                    <ol style="color: #666; line-height: 2; margin-left: 20px; margin-bottom: 20px;">
                        <li>Click the "Open Google Drive" button below</li>
                        <li>Download the zip file from Google Drive</li>
                        <li>Extract the zip file on your computer</li>
                        <li>Upload .ipynb files to Google Colab one by one</li>
                    </ol>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="${student.zipUrl}" 
                           target="_blank" 
                           class="btn btn-info btn-small"
                           style="text-decoration: none; display: inline-flex;">
                            üìÇ Open Google Drive
                        </a>
                        <a href="https://colab.research.google.com/" 
                           target="_blank" 
                           class="colab-btn"
                           style="text-decoration: none;">
                            üöÄ Open Google Colab
                        </a>
                        <button class="btn btn-small btn-secondary" onclick="copyToClipboard('${student.zipUrl.replace(/'/g, "\\'")}')">
                            üìã Copy Link
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <p style="color: #1565c0; font-size: 0.9rem; margin: 0;">
                            üí° <strong>Tip:</strong> Ask students to use Dropbox or direct links next time for automatic processing.
                        </p>
                    </div>
                </div>
            `;
            
            container.classList.add('expanded');
            student.zipExpanded = true;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Link copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please copy manually from the URL field above.');
            });
        }

        function displayZipFiles(index) {
            const student = studentsData[index];
            const container = document.getElementById(`zip-files-${index}`);
            
            if (!student.zipFiles || student.zipFiles.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 10px;">No .ipynb files found in zip</p>';
                return;
            }

            const fileWord = student.zipFiles.length === 1 ? 'notebook' : 'notebooks';
            container.innerHTML = `
                <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="color: #2e7d32; margin: 0; font-weight: 600;">
                        ‚úÖ Found ${student.zipFiles.length} ${fileWord}
                    </p>
                </div>
                ${student.zipFiles.map((file, fileIndex) => `
                    <div class="file-item">
                        <div class="file-name">
                            <span class="file-icon">üìì</span>
                            <span title="${file.fullPath}">${file.name}</span>
                        </div>
                        <button class="colab-btn" onclick="openInColab(${index}, ${fileIndex})">
                            üöÄ Open in Colab
                        </button>
                    </div>
                `).join('')}
            `;
        }

        function toggleZipFiles(index) {
            const student = studentsData[index];
            student.zipExpanded = !student.zipExpanded;
            const container = document.getElementById(`zip-files-${index}`);
            container.classList.toggle('expanded');
            
            const btn = document.getElementById(`toggle-zip-${index}`);
            btn.textContent = student.zipExpanded ? '‚ñº Hide Files' : '‚ñ∂ Show Files (' + student.zipFiles.length + ')';
        }

        async function openInColab(studentIndex, fileIndex) {
            const student = studentsData[studentIndex];
            const file = student.zipFiles[fileIndex];

            try {
                // Read the notebook content
                const content = await file.file.async('string');
                
                // Create a blob and download it
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Open Colab in a new tab
                window.open('https://colab.research.google.com/', '_blank');

                // Show improved instructions
                setTimeout(() => {
                    const instructions = `‚úÖ File "${file.name}" downloaded!

üöÄ Google Colab is opening in a new tab...

üìù Next steps:
1. In the Colab tab, click "File" ‚Üí "Upload notebook"
2. Select the downloaded file: ${file.name}
3. Start grading!

üí° Quick tip: You can also drag & drop the file into Colab.

‚å®Ô∏è Press OK to continue grading other students.`;
                    
                    alert(instructions);
                }, 500);

            } catch (error) {
                console.error('Error opening file:', error);
                alert('‚ùå Failed to extract file from zip. Please try again or download the zip manually.');
            }
        }

        function displayStudents() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('studentsGrid').style.display = 'block';

            updateSummary();

            const cardsContainer = document.getElementById('studentCards');
            cardsContainer.innerHTML = studentsData.map((student, index) => `
                <div class="student-card" id="card-${index}">
                    <div class="student-header">
                        <div class="student-info">
                            <h3>${student.fullName}</h3>
                            <p>ID: ${student.idNumber} | Email: ${student.email}</p>
                        </div>
                        <div class="total-grade">
                            <div class="total-grade-label">Total Grade</div>
                            <div class="total-grade-value" id="total-${index}">${student.totalGrade || '‚Äî'}</div>
                        </div>
                    </div>

                    ${student.zipUrl ? `
                    <div class="zip-section">
                        <div class="zip-header">
                            <div class="zip-title">
                                <span>üì¶</span>
                                <span>Submitted Notebooks</span>
                            </div>
                            ${!student.zipLoaded ? `
                                <button class="btn btn-small btn-warning" 
                                        id="load-zip-${index}"
                                        onclick="loadZipFile(${index})">
                                    üì• Load Zip File
                                </button>
                            ` : `
                                <button class="btn btn-small btn-info" 
                                        id="toggle-zip-${index}"
                                        onclick="toggleZipFiles(${index})">
                                    ‚ñº Hide Files (${student.zipFiles.length})
                                </button>
                            `}
                        </div>
                        <div class="zip-url">${student.zipUrl}</div>
                        <div class="files-list ${student.zipExpanded ? 'expanded' : ''}" id="zip-files-${index}">
                            <p style="color: #999; padding: 10px;">Click "Load Zip File" to view and download notebooks</p>
                        </div>
                    </div>
                    ` : `
                    <div class="zip-section" style="background: #f8f9fa; border: 1px dashed #ddd;">
                        <div style="padding: 15px; text-align: center; color: #666;">
                            <span style="font-size: 2rem;">‚úÖ</span>
                            <p style="margin: 10px 0 5px 0; font-weight: 600;">Already Graded</p>
                            <p style="margin: 0; font-size: 0.9rem;">No zip file needed - grades already recorded</p>
                        </div>
                    </div>
                    `}
                    
                    <div class="grades-grid">
                        <div class="grade-input-group">
                            <label>Question 1: Regression</label>
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                                    <div>
                                        <strong style="color: #667eea;">Total Grade</strong>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">Auto-calculated from checkmarks</div>
                                    </div>
                                    <strong style="font-size: 1.5rem; color: #667eea;" id="q1-total-${index}">0</strong>
                                </div>
                                
                                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9ff; border-radius: 6px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Manual Override (optional):</label>
                                    <input type="number" 
                                           id="q1-manual-${index}"
                                           placeholder="Leave empty to use calculated grade"
                                           style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px;"
                                           step="0.5"
                                           min="0"
                                           max="28"
                                           onchange="updateTotal(${index})">
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">üí° Only use this if you need to adjust the final grade</div>
                                </div>
                                
                                <details>
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 1: Data Loading (3 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q1-part-quick-${index}" data-part="p1" data-max="3" onchange="quickCheckPart(this, ${index}, 'q1', 'p1')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p1-task-${index}" data-task="q1-p1t1" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t1-${index}" class="q1-check-${index}" data-marks="0.25" onchange="calculateQ1(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t1-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p1-task-${index}" data-task="q1-p1t2" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t2-${index}" class="q1-check-${index}" data-marks="0.25" onchange="calculateQ1(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t2-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p1-task-${index}" data-task="q1-p1t3" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t3-${index}" class="q1-check-${index}" data-marks="0.25" onchange="calculateQ1(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t3-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p1-task-${index}" data-task="q1-p1t4" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t4-${index}" class="q1-check-${index}" data-marks="0.25" onchange="calculateQ1(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t4-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1.0):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p1-task-${index}" data-task="q1-p1t5" data-marks="1.0" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t5-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p1t5-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details>
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 2: Preprocessing (6-10 marks)
                                        <label style="margin-left: 20px; font-weight: normal; color: #888;" onclick="event.stopPropagation();">
                                            <em>Complex part - grade tasks individually</em>
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p2-task-${index}" data-task="q1-p2t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t1-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t1-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 10px; padding: 10px; background: #fff8e1; border-radius: 4px;">
                                            <strong style="color: #666;">Task 2 - Missing Values:</strong><br>
                                            <div style="margin-left: 20px; margin-top: 8px;">
                                                <strong style="color: #555;">Numeric Features:</strong><br>
                                                <label style="margin-left: 10px;"><input type="checkbox" class="q1-check-${index}" data-marks="1" onchange="calculateQ1(${index})"> Filled numeric (1)</label><br>
                                                <label style="margin-left: 10px;"><input type="checkbox" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Dropped numeric rows/features (0.5)</label><br>
                                                <strong style="color: #555; margin-top: 8px; display: block;">Categorical Features:</strong>
                                                <label style="margin-left: 10px;"><input type="checkbox" class="q1-check-${index}" data-marks="1" onchange="calculateQ1(${index})"> Filled categorical (1)</label><br>
                                                <label style="margin-left: 10px;"><input type="checkbox" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Dropped categorical rows/features (0.5)</label><br>
                                                <strong style="color: #555; margin-top: 8px; display: block;">Target Variable:</strong>
                                                <label style="margin-left: 10px;"><input type="radio" name="q1-target-${index}" class="q1-check-${index}" data-marks="2" onchange="calculateQ1(${index})"> Dropped rows with missing target (+2)</label><br>
                                                <label style="margin-left: 10px;"><input type="radio" name="q1-target-${index}" class="q1-check-${index}" data-marks="-2" onchange="calculateQ1(${index})"> Did NOT drop target (-2)</label><br>
                                                <label style="margin-left: 10px;"><input type="radio" name="q1-target-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> N/A (0)</label>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p2-task-${index}" data-task="q1-p2t3" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t3-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t3-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 - Encoding:</strong><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task4-${index}" class="q1-check-${index}" data-marks="3" onchange="calculateQ1(${index})"> One-Hot Encoding Full (3)</label><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task4-${index}" class="q1-check-${index}" data-marks="1.5" onchange="calculateQ1(${index})"> One-Hot Encoding Half (1.5)</label><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task4-${index}" class="q1-check-${index}" data-marks="1" onchange="calculateQ1(${index})"> Label Encoding Full (1)</label><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task4-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Label Encoding Half (0.5)</label><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task4-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p2-task-${index}" data-task="q1-p2t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t5-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p2t5-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 6:</strong><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task6-${index}" class="q1-check-${index}" data-marks="-1" onchange="calculateQ1(${index})"> Plotted anything (-1)</label><br>
                                            <label style="margin-left: 20px;"><input type="radio" name="q1-task6-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> Kept empty/comment (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 3: Model Building (6 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q1-part-quick-${index}" data-part="p3" data-max="6" onchange="quickCheckPart(this, ${index}, 'q1', 'p3')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p3-task-${index}" data-task="q1-p3t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t1-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t1-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p3-task-${index}" data-task="q1-p3t2" data-marks="2" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t2-${index}" class="q1-check-${index}" data-marks="1" onchange="calculateQ1(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t2-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p3-task-${index}" data-task="q1-p3t3" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t3-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t3-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p3-task-${index}" data-task="q1-p3t4" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t4-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t4-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p3-task-${index}" data-task="q1-p3t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t5-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p3t5-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 4: Evaluation (3 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q1-part-quick-${index}" data-part="p4" data-max="3" onchange="quickCheckPart(this, ${index}, 'q1', 'p4')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p4-task-${index}" data-task="q1-p4t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p4t1-${index}" class="q1-check-${index}" data-marks="0.5" onchange="calculateQ1(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p4t1-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-p4-task-${index}" data-task="q1-p4t2" data-marks="2" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p4t2-${index}" class="q1-check-${index}" data-marks="1" onchange="calculateQ1(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-p4t2-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 5: Bonus (3 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q1-part-quick-${index}" data-part="bonus" data-max="3" onchange="quickCheckPart(this, ${index}, 'q1', 'bonus')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Bonus (3):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q1-quick-${index} q1-bonus-task-${index}" data-task="q1-bonus" data-marks="3" onchange="quickCheck(this, ${index}, 'q1')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-bonus-${index}" class="q1-check-${index}" data-marks="1.5" onchange="calculateQ1(${index})"> Half (1.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q1-bonus-${index}" class="q1-check-${index}" data-marks="0" onchange="calculateQ1(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <input type="checkbox" 
                                       id="q1ai-${index}" 
                                       ${student.q1AIFlag ? 'checked' : ''}
                                       onchange="updateTotal(${index})">
                                <label for="q1ai-${index}">AI Detected</label>
                            </div>
                        </div>

                        <div class="grade-input-group">
                            <label>Question 2: PyTorch</label>
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                                    <div>
                                        <strong style="color: #667eea;">Total Grade</strong>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">Auto-calculated from checkmarks</div>
                                    </div>
                                    <strong style="font-size: 1.5rem; color: #667eea;" id="q2-total-${index}">0</strong>
                                </div>
                                
                                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9ff; border-radius: 6px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Manual Override (optional):</label>
                                    <input type="number" 
                                           id="q2-manual-${index}"
                                           placeholder="Leave empty to use calculated grade"
                                           style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px;"
                                           step="0.5"
                                           min="0"
                                           max="19"
                                           onchange="updateTotal(${index})">
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">üí° Only use this if you need to adjust the final grade</div>
                                </div>
                                
                                <details>
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 1: Data Preparation (5 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q2-part-quick-${index}" data-part="p1" data-max="5" onchange="quickCheckPart(this, ${index}, 'q2', 'p1')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p1-task-${index}" data-task="q2-p1t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t1-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t1-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p1-task-${index}" data-task="q2-p1t2" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t2-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t2-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p1-task-${index}" data-task="q2-p1t3" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t3-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t3-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p1-task-${index}" data-task="q2-p1t4" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t4-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t4-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p1-task-${index}" data-task="q2-p1t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t5-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p1t5-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 2: Model Building (8 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q2-part-quick-${index}" data-part="p2" data-max="8" onchange="quickCheckPart(this, ${index}, 'q2', 'p2')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p2-task-${index}" data-task="q2-p2t1" data-marks="2" onchange="quickCheck(this, ${index}, \'q2\')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t1-${index}" class="q2-check-${index}" data-marks="1" onchange="calculateQ2(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t1-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p2-task-${index}" data-task="q2-p2t2" data-marks="1" onchange="quickCheck(this, ${index}, \'q2\')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t2-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t2-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p2-task-${index}" data-task="q2-p2t3" data-marks="2" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t3-${index}" class="q2-check-${index}" data-marks="1" onchange="calculateQ2(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t3-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p2-task-${index}" data-task="q2-p2t4" data-marks="2" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t4-${index}" class="q2-check-${index}" data-marks="1" onchange="calculateQ2(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t4-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p2-task-${index}" data-task="q2-p2t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t5-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p2t5-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 3: Training & Evaluation (4 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q2-part-quick-${index}" data-part="p3" data-max="4" onchange="quickCheckPart(this, ${index}, 'q2', 'p3')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-p3-task-${index}" data-task="q2-p3t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p3t1-${index}" class="q2-check-${index}" data-marks="0.5" onchange="calculateQ2(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-p3t1-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Bonus (3 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q2-part-quick-${index}" data-part="bonus" data-max="3" onchange="quickCheckPart(this, ${index}, 'q2', 'bonus')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 Bonus (3):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q2-quick-${index} q2-bonus-task-${index}" data-task="q2-bonus" data-marks="3" onchange="quickCheck(this, ${index}, 'q2')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-bonus-${index}" class="q2-check-${index}" data-marks="1.5" onchange="calculateQ2(${index})"> Half (1.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q2-bonus-${index}" class="q2-check-${index}" data-marks="0" onchange="calculateQ2(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <input type="checkbox" 
                                       id="q2ai-${index}" 
                                       ${student.q2AIFlag ? 'checked' : ''}
                                       onchange="updateTotal(${index})">
                                <label for="q2ai-${index}">AI Detected</label>
                            </div>
                        </div>

                        <div class="grade-input-group">
                            <label>Question 3: Classification</label>
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                                    <div>
                                        <strong style="color: #667eea;">Total Grade</strong>
                                        <div style="font-size: 0.75rem; color: #999; margin-top: 3px;">Auto-calculated from checkmarks</div>
                                    </div>
                                    <strong style="font-size: 1.5rem; color: #667eea;" id="q3-total-${index}">0</strong>
                                </div>
                                
                                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9ff; border-radius: 6px;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Manual Override (optional):</label>
                                    <input type="number" 
                                           id="q3-manual-${index}"
                                           placeholder="Leave empty to use calculated grade"
                                           style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px;"
                                           step="0.5"
                                           min="0"
                                           max="22"
                                           onchange="updateTotal(${index})">
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">üí° Only use this if you need to adjust the final grade</div>
                                </div>
                                
                                <details>
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 1: Data Loading (2 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q3-part-quick-${index}" data-part="p1" data-max="2" onchange="quickCheckPart(this, ${index}, 'q3', 'p1')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p1-task-${index}" data-task="q3-p1t1" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t1-${index}" class="q3-check-${index}" data-marks="0.25" onchange="calculateQ3(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t1-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p1-task-${index}" data-task="q3-p1t2" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t2-${index}" class="q3-check-${index}" data-marks="0.25" onchange="calculateQ3(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t2-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p1-task-${index}" data-task="q3-p1t3" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t3-${index}" class="q3-check-${index}" data-marks="0.25" onchange="calculateQ3(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t3-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (0.5):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p1-task-${index}" data-task="q3-p1t4" data-marks="0.5" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t4-${index}" class="q3-check-${index}" data-marks="0.25" onchange="calculateQ3(${index})"> Half (0.25)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p1t4-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 2: Preprocessing (5 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q3-part-quick-${index}" data-part="p2" data-max="5" onchange="quickCheckPart(this, ${index}, 'q3', 'p2')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p2-task-${index}" data-task="q3-p2t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t1-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t1-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p2-task-${index}" data-task="q3-p2t2" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t2-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t2-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p2-task-${index}" data-task="q3-p2t3" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t3-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t3-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p2-task-${index}" data-task="q3-p2t4" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t4-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t4-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p2-task-${index}" data-task="q3-p2t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t5-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p2t5-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 3: Model Building (7 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q3-part-quick-${index}" data-part="p3" data-max="7" onchange="quickCheckPart(this, ${index}, 'q3', 'p3')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p3-task-${index}" data-task="q3-p3t1" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t1-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t1-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p3-task-${index}" data-task="q3-p3t2" data-marks="2" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t2-${index}" class="q3-check-${index}" data-marks="1" onchange="calculateQ3(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t2-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 3 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p3-task-${index}" data-task="q3-p3t3" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t3-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t3-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 4 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p3-task-${index}" data-task="q3-p3t4" data-marks="2" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t4-${index}" class="q3-check-${index}" data-marks="1" onchange="calculateQ3(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t4-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 5 (1):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p3-task-${index}" data-task="q3-p3t5" data-marks="1" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t5-${index}" class="q3-check-${index}" data-marks="0.5" onchange="calculateQ3(${index})"> Half (0.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p3t5-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 4: Evaluation (5 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q3-part-quick-${index}" data-part="p4" data-max="5" onchange="quickCheckPart(this, ${index}, 'q3', 'p4')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 1 (2):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p4-task-${index}" data-task="q3-p4t1" data-marks="2" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p4t1-${index}" class="q3-check-${index}" data-marks="1" onchange="calculateQ3(${index})"> Half (1)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p4t1-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                        <div style="margin-bottom: 5px;">
                                            <strong>Task 2 (3):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-p4-task-${index}" data-task="q3-p4t2" data-marks="3" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p4t2-${index}" class="q3-check-${index}" data-marks="1.5" onchange="calculateQ3(${index})"> Half (1.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-p4t2-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                                        Part 5: Bonus (3 marks)
                                        <label style="margin-left: 20px; font-weight: normal;" onclick="event.stopPropagation();">
                                            <input type="checkbox" class="q1-part-quick-${index}" data-part="bonus" data-max="3" onchange="quickCheckPart(this, ${index}, 'q1', 'bonus')"> ‚úì Full Part
                                        </label>
                                    </summary>
                                    <div style="padding-left: 15px; line-height: 2;">
                                        <div style="margin-bottom: 5px;">
                                            <strong>Bonus (3):</strong>
                                            <label style="margin-left: 10px;"><input type="checkbox" class="q3-quick-${index} q3-bonus-task-${index}" data-task="q3-bonus" data-marks="3" onchange="quickCheck(this, ${index}, 'q3')"> ‚úì Full</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-bonus-${index}" class="q3-check-${index}" data-marks="1.5" onchange="calculateQ3(${index})"> Half (1.5)</label>
                                            <label style="margin-left: 10px;"><input type="radio" name="q3-bonus-${index}" class="q3-check-${index}" data-marks="0" onchange="calculateQ3(${index})" checked> None (0)</label>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <input type="checkbox" 
                                       id="q3ai-${index}" 
                                       ${student.q3AIFlag ? 'checked' : ''}
                                       onchange="updateTotal(${index})">
                                <label for="q3ai-${index}">AI Detected</label>
                            </div>
                        </div>
                    </div>

                    <div class="student-actions">
                        <button class="btn btn-small" onclick="downloadStudentSheet(${index})">
                            üìÑ Download Grading Sheet
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function quickCheckPart(checkbox, index, question, part) {
            const isChecked = checkbox.checked;
            // Find all task checkboxes for this part
            const partTasks = document.querySelectorAll(`.${question}-${part}-task-${index}`);
            
            partTasks.forEach(taskCheckbox => {
                taskCheckbox.checked = isChecked;
                // Trigger the task's quick check
                quickCheck(taskCheckbox, index, question);
            });
        }

        function quickCheck(checkbox, index, question) {
            const taskName = checkbox.getAttribute('data-task');
            const marks = checkbox.getAttribute('data-marks');
            
            if (checkbox.checked) {
                // Select the "Full" radio button for this task
                const radios = document.querySelectorAll(`input[name="${taskName}-${index}"]`);
                radios.forEach(radio => {
                    if (radio.getAttribute('data-marks') === marks) {
                        radio.checked = true;
                    }
                });
            } else {
                // Select the "None" radio button
                const radios = document.querySelectorAll(`input[name="${taskName}-${index}"]`);
                radios.forEach(radio => {
                    if (radio.getAttribute('data-marks') === '0') {
                        radio.checked = true;
                    }
                });
            }
            
            // Trigger calculation
            if (question === 'q1') calculateQ1(index);
            else if (question === 'q2') calculateQ2(index);
            else if (question === 'q3') calculateQ3(index);
        }

        function calculateQ1(index) {
            // Check if manual override is being used
            const manualInput = document.getElementById(`q1-manual-${index}`);
            if (manualInput && manualInput.value !== '') {
                // Manual override active - update display but don't recalculate
                studentsData[index].q1Grade = parseFloat(manualInput.value);
                document.getElementById(`q1-total-${index}`).textContent = manualInput.value;
                updateTotal(index);
                return;
            }
            
            // Calculate from checkboxes
            const checkboxes = document.querySelectorAll(`.q1-check-${index}`);
            let total = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseFloat(cb.getAttribute('data-marks'));
                }
            });
            
            // Ensure total doesn't go below 0
            total = Math.max(0, total);
            
            document.getElementById(`q1-total-${index}`).textContent = total.toFixed(1);
            studentsData[index].q1Grade = total;
            updateTotal(index);
        }

        function calculateQ2(index) {
            // Check if manual override is being used
            const manualInput = document.getElementById(`q2-manual-${index}`);
            if (manualInput && manualInput.value !== '') {
                studentsData[index].q2Grade = parseFloat(manualInput.value);
                document.getElementById(`q2-total-${index}`).textContent = manualInput.value;
                updateTotal(index);
                return;
            }
            
            const checkboxes = document.querySelectorAll(`.q2-check-${index}`);
            let total = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseFloat(cb.getAttribute('data-marks'));
                }
            });
            
            total = Math.max(0, total);
            
            document.getElementById(`q2-total-${index}`).textContent = total.toFixed(1);
            studentsData[index].q2Grade = total;
            updateTotal(index);
        }

        function calculateQ3(index) {
            // Check if manual override is being used
            const manualInput = document.getElementById(`q3-manual-${index}`);
            if (manualInput && manualInput.value !== '') {
                studentsData[index].q3Grade = parseFloat(manualInput.value);
                document.getElementById(`q3-total-${index}`).textContent = manualInput.value;
                updateTotal(index);
                return;
            }
            
            const checkboxes = document.querySelectorAll(`.q3-check-${index}`);
            let total = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseFloat(cb.getAttribute('data-marks'));
                }
            });
            
            total = Math.max(0, total);
            
            document.getElementById(`q3-total-${index}`).textContent = total.toFixed(1);
            studentsData[index].q3Grade = total;
            updateTotal(index);
        }

        function updateTotal(index) {
            const q1 = studentsData[index].q1Grade || 0;
            const q2 = studentsData[index].q2Grade || 0;
            const q3 = studentsData[index].q3Grade || 0;

            const total = q1 + q2 + q3;
            
            studentsData[index].q1AIFlag = document.getElementById(`q1ai-${index}`).checked;
            studentsData[index].q2AIFlag = document.getElementById(`q2ai-${index}`).checked;
            studentsData[index].q3AIFlag = document.getElementById(`q3ai-${index}`).checked;
            studentsData[index].totalGrade = total;

            document.getElementById(`total-${index}`).textContent = total.toFixed(1);
            updateSummary();
        }

        function updateSummary() {
            const total = studentsData.length;
            const graded = studentsData.filter(s => s.totalGrade !== '' && s.totalGrade !== 0).length;
            const pending = total - graded;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('gradedStudents').textContent = graded;
            document.getElementById('pendingStudents').textContent = pending;
        }

        function downloadStudentSheet(index) {
            const student = studentsData[index];
            const wb = XLSX.utils.book_new();
            
            const wsData = [
                ['Student Grading Sheet'],
                [''],
                ['Full Name', student.fullName],
                ['ID/IQAMA Number', student.idNumber],
                ['Email', student.email],
                ['Please upload a zip file of all solved notebooks!', student.zipUrl || ''],
                [''],
                ['Question 1 Grade', student.q1Grade || ''],
                ['Question 1 AI Flag', student.q1AIFlag ? 'yes' : 'no'],
                [''],
                ['Question 2 Grade', student.q2Grade || ''],
                ['Question 2 AI Flag', student.q2AIFlag ? 'yes' : 'no'],
                [''],
                ['Question 3 Grade', student.q3Grade || ''],
                ['Question 3 AI Flag', student.q3AIFlag ? 'yes' : 'no'],
                [''],
                ['Total Grade', student.totalGrade || '']
            ];

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                { wch: 25 },
                { wch: 40 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Grading Sheet');
            
            const fileName = `${student.fullName.replace(/\s+/g, '_')}_grading_sheet.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function downloadAllSheets() {
            const wb = XLSX.utils.book_new();
            
            const allData = studentsData.map(student => ({
                'Full Name': student.fullName,
                'ID/IQAMA Number': student.idNumber,
                'Email': student.email,
                'Please upload a zip file of all solved notebooks!': student.zipUrl || '',
                'Q1 Grade': student.q1Grade || '',
                'Q1 AI Flag': student.q1AIFlag ? 'yes' : 'no',
                'Q2 Grade': student.q2Grade || '',
                'Q2 AI Flag': student.q2AIFlag ? 'yes' : 'no',
                'Q3 Grade': student.q3Grade || '',
                'Q3 AI Flag': student.q3AIFlag ? 'yes' : 'no',
                'Total Grade': student.totalGrade || ''
            }));

            const ws = XLSX.utils.json_to_sheet(allData);
            
            ws['!cols'] = [
                { wch: 30 },
                { wch: 15 },
                { wch: 30 },
                { wch: 50 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 },
                { wch: 12 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'All Students');
            
            const timestamp = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `grading_sheet_complete_${timestamp}.xlsx`);
        }

        function resetApp() {
            if (confirm('Are you sure you want to start over? Any unsaved changes will be lost.')) {
                location.reload();
            }
        }
    </script>
</body>
</html>
